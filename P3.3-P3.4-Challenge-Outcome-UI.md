# Challenge Outcome Branches + Result UI (P3.3 + P3.4)

**Status:** In Progress
**Created:** 2025-12-17

## Overview

This document contains the UI mockups and implementation plan for the Challenge Outcome Branches and Result UI feature.

## Key Flow

1. Challenge created with pre-generated outcomes per tier
2. Player rolls, outcome tier determined
3. DM gets approval notification (accept/edit/suggest)
4. Player's roll modal shows "Waiting for DM..."
5. After approval, player sees animated result display
6. Result also appears as special dialogue entry

---

## UI Mockups

### Player: Roll Modal - Input Phase

```
+------------------------------------------+
|                                          |
|           STEALTH CHECK                  |
|           vs DC 15                       |
|                                          |
|   Your Modifier: +3                      |
|                                          |
|   +----------------------------------+   |
|   |  [ ] Use digital dice            |   |
|   |      Formula: 1d20               |   |
|   |                                  |   |
|   |  [x] Enter physical roll         |   |
|   |      Result: [  18  ]            |   |
|   +----------------------------------+   |
|                                          |
|          [   Submit Roll   ]             |
|                                          |
+------------------------------------------+
```

### Player: Roll Modal - Awaiting Approval Phase

```
+------------------------------------------+
|                                          |
|           [Spinning Indicator]           |
|                                          |
|           Roll Submitted                 |
|                                          |
|   +----------------------------------+   |
|   |  Stealth Check                   |   |
|   |                                  |   |
|   |            21                    |   |
|   |                                  |   |
|   |    Roll: 18 + Modifier: 3        |   |
|   +----------------------------------+   |
|                                          |
|     Waiting for DM to confirm the        |
|     outcome...                           |
|                                          |
+------------------------------------------+
```

### Player: Roll Modal - Result Display Phase

```
+------------------------------------------+
|                                          |
|         *** SUCCESS ***                  |
|     (green glow, pulse animation)        |
|                                          |
|   +----------------------------------+   |
|   |  Roll           18               |   |
|   |  Modifier       +3               |   |
|   |  ------------------------------- |   |
|   |  Total          21               |   |
|   +----------------------------------+   |
|                                          |
|   +----------------------------------+   |
|   | You slip past the guards         |   |
|   | unnoticed, their attention       |   |
|   | focused on the commotion you     |   |
|   | created earlier. The door        |   |
|   | ahead looms invitingly.          |   |
|   +----------------------------------+   |
|                                          |
|          [    Continue    ]              |
|                                          |
+------------------------------------------+
```

### Player: Critical Success Result

```
+------------------------------------------+
|                                          |
|    *** CRITICAL SUCCESS ***              |
|    (gold glow, star burst animation)     |
|                                          |
|   +----------------------------------+   |
|   |  Natural 20!                     |   |
|   |  Roll: 20 + Modifier: 3 = 23     |   |
|   +----------------------------------+   |
|                                          |
|   +----------------------------------+   |
|   | You move like a shadow incarnate,|   |
|   | not only evading the guards but  |   |
|   | plucking a key from one's belt   |   |
|   | as you pass. They remain         |   |
|   | blissfully unaware.              |   |
|   +----------------------------------+   |
|                                          |
|          [    Continue    ]              |
|                                          |
+------------------------------------------+
```

### Player: Failure Result

```
+------------------------------------------+
|                                          |
|           *** FAILURE ***                |
|        (red glow, shake animation)       |
|                                          |
|   +----------------------------------+   |
|   |  Roll           8                |   |
|   |  Modifier       +3               |   |
|   |  ------------------------------- |   |
|   |  Total          11               |   |
|   +----------------------------------+   |
|                                          |
|   +----------------------------------+   |
|   | Your foot catches on a loose     |   |
|   | stone, sending it skittering     |   |
|   | across the floor. The guards     |   |
|   | turn toward the sound, hands     |   |
|   | moving to their weapons.         |   |
|   +----------------------------------+   |
|                                          |
|          [    Continue    ]              |
|                                          |
+------------------------------------------+
```

### DM: Decision Queue - Challenge Outcome Card

```
+------------------------------------------+
| Decision Queue                    [x] [] |
+------------------------------------------+
| CHALLENGE RESULTS                        |
+------------------------------------------+
| +-[green border]-------------------------+
| | Stealth Check              SUCCESS    ||
| | by Talia the Rogue                    ||
| +---------------------------------------+|
| | Roll: 18  Mod: +3  Total: 21  DC: 15  ||
| +---------------------------------------+|
| |                                       ||
| | [ Outcome Description                ]||
| | [ You slip past the guards           ]||
| | [ unnoticed...                       ]||
| | [                                    ]||
| |                                       ||
| | Triggers: reveal_info (minor)         ||
| +---------------------------------------+|
| |                                       ||
| | [Accept] [Suggest] [Edit]             ||
| |                                       ||
| +---------------------------------------+|
+------------------------------------------+
```

### DM: Outcome Card in Edit Mode

```
+------------------------------------------+
| +-[amber border]-------------------------+
| | Stealth Check              SUCCESS    ||
| | by Talia the Rogue         EDITING    ||
| +---------------------------------------+|
| | Roll: 18  Mod: +3  Total: 21  DC: 15  ||
| +---------------------------------------+|
| |                                       ||
| | +-----------------------------------+ ||
| | | You slip past the guards          | ||
| | | unnoticed. One of them mutters    | ||
| | | about the cold draft as you pass. | ||
| | |                                   | ||
| | |                         [150/300] | ||
| | +-----------------------------------+ ||
| |                                       ||
| | [Accept Edit] [Cancel] [Suggest]      ||
| |                                       ||
| +---------------------------------------+|
+------------------------------------------+
```

### DM: Outcome Card with LLM Suggestions

```
+------------------------------------------+
| +-[purple border]------------------------+
| | Stealth Check              SUCCESS    ||
| | by Talia the Rogue      SUGGESTIONS   ||
| +---------------------------------------+|
| | Roll: 18  Mod: +3  Total: 21  DC: 15  ||
| +---------------------------------------+|
| |                                       ||
| | LLM Suggestions:                      ||
| | +-----------------------------------+ ||
| | | [Click to use]                    | ||
| | | You slip through the shadows like | ||
| | | water through fingers...          | ||
| | +-----------------------------------+ ||
| | | [Click to use]                    | ||
| | | The guards' eyes pass over you    | ||
| | | as if you were part of the wall...| ||
| | +-----------------------------------+ ||
| | | [Click to use]                    | ||
| | | Moving with practiced ease, you   | ||
| | | reach the door undetected...      | ||
| | +-----------------------------------+ ||
| |                                       ||
| | [Use Selected] [Request New] [Cancel] ||
| |                                       ||
| +---------------------------------------+|
+------------------------------------------+
```

### Dialogue Box: Challenge Result Entry

```
+------------------------------------------+
|                                          |
| [Backdrop: Shadowy Hallway]              |
|                                          |
|   +-----+                                |
|   |Guard|                                |
|   +-----+                                |
|                                          |
+------------------------------------------+
| +--------------------------------------+ |
| | STEALTH CHECK                SUCCESS | |
| | ------------------------------------ | |
| | Talia rolled 18 + 3 = 21 (DC 15)     | |
| |                                      | |
| | You slip past the guards unnoticed,  | |
| | their attention focused on the       | |
| | commotion you created earlier.       | |
| +--------------------------------------+ |
+------------------------------------------+
|                                          |
|  > What do you do next?                  |
|                                          |
|  [Continue exploring]  [Check the door]  |
|                                          |
+------------------------------------------+
```

---

## Implementation Status

### Engine (Completed)

- [x] DTOs: `PendingChallengeResolutionDto`, `ChallengeOutcomeDecision`
- [x] Queue item: `ChallengeOutcomeApprovalItem`
- [x] WebSocket messages: `ChallengeRollSubmitted`, `ChallengeOutcomePending`, `OutcomeSuggestionReady`
- [x] Client messages: `ChallengeOutcomeDecision`, `RequestOutcomeSuggestion`
- [x] Service: `ChallengeOutcomeApprovalService`
- [x] Service: `OutcomeSuggestionService`
- [ ] Wire services into WebSocket handlers (placeholder handlers exist)
- [ ] Modify `ChallengeResolutionService` to use approval flow

### Player (Pending)

- [ ] State: Add `RollSubmissionStatus` to `ChallengeState`
- [ ] State: Add `PendingChallengeOutcome` to `ApprovalState`
- [ ] Handler: Process new server message types
- [ ] Component: Transform `ChallengeRollModal` with three phases
- [ ] Component: Create `ChallengeOutcomeApproval` for DM panel
- [ ] Component: Update `DecisionQueuePanel` integration
- [ ] Component: Add challenge result to dialogue rendering

---

## WebSocket Protocol

### New Server → Player Messages

```json
// Sent to player after roll submission
{
  "type": "ChallengeRollSubmitted",
  "challenge_id": "uuid",
  "challenge_name": "Stealth Check",
  "roll": 18,
  "modifier": 3,
  "total": 21,
  "outcome_type": "Success",
  "status": "awaiting_dm_approval"
}

// Sent to DM for approval queue
{
  "type": "ChallengeOutcomePending",
  "resolution_id": "uuid",
  "challenge_id": "uuid",
  "challenge_name": "Stealth Check",
  "character_id": "pc-uuid",
  "character_name": "Talia",
  "roll": 18,
  "modifier": 3,
  "total": 21,
  "outcome_type": "Success",
  "outcome_description": "You slip past the guards...",
  "outcome_triggers": [...],
  "roll_breakdown": "1d20(18) + 3 = 21"
}

// Sent when LLM suggestions ready
{
  "type": "OutcomeSuggestionReady",
  "resolution_id": "uuid",
  "suggestions": [
    "You slip through the shadows...",
    "The guards' eyes pass over you...",
    "Moving with practiced ease..."
  ]
}
```

### New Player → Engine Messages

```json
// DM decision on outcome
{
  "type": "ChallengeOutcomeDecision",
  "resolution_id": "uuid",
  "decision": { "action": "accept" }
}

// Or with edit
{
  "type": "ChallengeOutcomeDecision",
  "resolution_id": "uuid",
  "decision": {
    "action": "edit",
    "modified_description": "You slip past the guards unnoticed. One mutters about a cold draft."
  }
}

// Request LLM suggestion
{
  "type": "RequestOutcomeSuggestion",
  "resolution_id": "uuid",
  "guidance": "Make it more dramatic"
}
```

---

## Files Modified

### Engine

| File | Status |
|------|--------|
| `src/application/dto/challenge.rs` | Modified - Added approval DTOs |
| `src/application/dto/queue_items.rs` | Modified - Added `ChallengeOutcomeApprovalItem` |
| `src/application/dto/mod.rs` | Modified - Exports |
| `src/infrastructure/websocket/messages.rs` | Modified - New message types |
| `src/infrastructure/websocket.rs` | Modified - Placeholder handlers |
| `src/application/services/challenge_outcome_approval_service.rs` | NEW |
| `src/application/services/outcome_suggestion_service.rs` | NEW |
| `src/application/services/mod.rs` | Modified - Exports |

### Player (TODO)

| File | Status |
|------|--------|
| `src/presentation/state/challenge_state.rs` | TODO - Add roll status |
| `src/presentation/state/approval_state.rs` | TODO - Add pending outcomes |
| `src/presentation/handlers/session_message_handler.rs` | TODO - New handlers |
| `src/presentation/components/tactical/challenge_roll.rs` | TODO - Transform modal |
| `src/presentation/components/dm_panel/challenge_outcome_approval.rs` | TODO - NEW |
| `src/presentation/components/dm_panel/decision_queue.rs` | TODO - Integration |
| `src/application/dto/websocket_messages.rs` | TODO - New messages |
